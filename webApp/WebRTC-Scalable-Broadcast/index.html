<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <h3 id='streamer'></h3>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.2.min.js" integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/6.0.2/simplepeer.min.js"></script>
    <video id="video-player" width="400" height="300" autoplay></video>
  </body>
</html>
<script>

var socket = io.connect();

navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;

var peers = {
  'id': { // <- actual id
    'peer': null,
    'isConnected': false
  }
};

var outsideStream;

socket.on('become-streamer', function(allIDs) {
  console.log('become-streamer')
  // get video stream
  navigator.getUserMedia({ video: true, audio: false }, function(stream) {
    // make stream global for peers who connect later
    outsideStream = stream;
    // create peer connections wil all sockets and stream to them
      allIDs.forEach(function(id) {
        peers[id] = {};
        peers[id].isConnected = false;
        peers[id].peer = new SimplePeer({ initiator: true, stream: stream, trickle: false})
        peers[id].peer.on('signal', function(data) {
          if (!peers[id].isConnected) {
            socket.emit('connect-to-peer', {id: id, SDP: data})
            peers[id].isConnected = true
          }
        })
      })
  }, function(error) {
    console.log(error)
  })
})

// as new peers join give them the stream
socket.on('new-peer', function(id) {
  console.log('new-peer', id)
  peers[id] = {};
  peers[id].peer = new SimplePeer({ initiator: true, stream: outsideStream, trickle: false })
  peers[id].peer.on('signal', function(data) {
    if (!peers[id].isConnected) {
      console.log(data)
      socket.emit('connect-to-peer', {id: id, SDP: data})
      peers[id].isConnected = true;
    }
  })
})

socket.on('signal-peer2', function(data) {
  console.log(data.id)
  console.log(peers[data.id].peer)
  // peers[data.id] = {};
  peers[data.id].peer.signal(data.SDP);
})

// if you are not the streamer connect with them
socket.on('connect-to-streamers-peer', function(data) {
  console.log('connect-to-streamers-peer', data.SDP)
  // handle the case where video streamer is the peer
  console.log('not undefined:', peers[data.id])

    peers[data.id] = {};
    peers[data.id].isConnected = false;
    peers[data.id].peer = new SimplePeer();
    peers[data.id].peer.signal(data.SDP);
    peers[data.id].peer.on('signal', function(SDP) {
      if (!peers[data.id].isConnected) {
        socket.emit('signal-peer1', {id: data.id, SDP: SDP})
        peers[data.id].isConnected = true;
      }
    })
    peers[data.id].peer.on('stream', function (stream) {
      // got remote video stream, now let's show it in a video tag
      var video = document.getElementById('video-player')
      console.log('video! stream', stream)
      video.src = window.URL.createObjectURL(stream)
      video.play()
    })
})

// turn off webcam if not streaming
socket.on('stop-streaming', function() {
  $('#streamer').html('')
  console.log('stop-streaming')
  outsideStream.getVideoTracks()[0].stop();
  peers = {}; // clear all peers in case we become the streamer again
})



// if (peers[data.id] !== undefined) {
//   $('#streamer').html('STREAMER')
//   var video = document.getElementById('video-player')
//   video.src = window.URL.createObjectURL(outsideStream)
// } else {
//   // clear peers
//   peers = {};


</script>
