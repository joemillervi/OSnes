<script src="http://cdn.dashjs.org/latest/dash.all.min.js"></script>
<script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"> </script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<body>
  <video id="live" autoplay></video>
  <canvas id="snapshot" style="display:none"></canvas>
   <div>
       <!-- <video data-dashjs-player autoplay src="http://dash.edgesuite.net/envivio/EnvivioDash3/manifest.mpd" controls></video> -->
       <!doctype html>
       <video id="player" autoplay="true"></video>
       <img id ="streamImg" src="" alt="">
       <!-- <video class="player" autoplay style="width:40%;"></video> -->
   </div>
   <style>

      body {
      margin: 0px;
      padding: 0px;
      }

      #player {
      width: 50%;
      height: 50%;
      }
   </style>
   <script>
       var socket = io()

       var mediaOptions = { audio: false, video: true };

       if (!navigator.getUserMedia) {
           navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
       }

       if (!navigator.getUserMedia){
          alert('getUserMedia not supported in this browser.');
       }

       navigator.getUserMedia(mediaOptions, success, function(e) {
         console.log(e);
       });

       function success(stream){
         // stream to webcam
         var live = document.querySelector("#player");
         live.src = window.URL.createObjectURL(stream);
         snapshot = document.getElementById("snapshot")

         // take snapshot of webcam and send to server
         setInterval(function() {
           snap();
         }, 50)

         function snap() {
            // Make the canvas the same size as the live video
            snapshot.width = live.clientWidth
            snapshot.height = live.clientHeight

            // Draw a frame of the live video onto the canvas
            c = snapshot.getContext("2d")
            c.drawImage(live, 0, 0, snapshot.width, snapshot.height)

            // Create an image element with the canvas image data
            img = document.createElement("img")
            img.src = snapshot.toDataURL("image/jpeg")
            img.style.padding = 5
            img.width = snapshot.width / 2
            img.height = snapshot.height / 2

            // send img to server
            socket.emit('uploadFrame', img.src)
            console.log('sent img to server', img.src.slice(0, 50))
          }
       }
      var currentNetworkLatency;
      var streamImg = document.getElementById("streamImg");

      // render new frame and update currentNetworkLatency
       socket.on('newFrame', function(data){
         streamImg.src = data.img;
         streamImg.timeCreated = data.timeCreated;
         currentNetworkLatency = new Date().getTime() - streamImg.timeCreated;
        //  console.log('NEW FRAME', data.img.slice(0, 100), 'timeSent:', data.timeCreated)
        //  console.log('current NETWORK latency:', new Date().getTime() - streamImg.timeCreated)
       });

      // Dynamically adjust video quality from server
      setInterval(function() {
        var currentTime = new Date().getTime();
        // Sometime images will pile up in chrome memory before being rendered
        var lagTime = currentTime - streamImg.timeCreated;
        console.log('Total Lag time from server:', lagTime)
      }, 1000)

    //    function blobToImage(imageData) {
    //      if (Blob && 'undefined' != typeof URL) {
    //        var blob = new Blob([imageData], {type: 'image/png'});
    //        return URL.createObjectURL(blob);
    //      } else if (imageData.base64) {
    //        return 'data:image/png;base64,' + imageData.data;
    //      } else {
    //        return 'about:blank';
    //      }
    //    }
    // // fetch data blob
   </script>
</body>
